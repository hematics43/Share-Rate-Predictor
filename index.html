<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Share Rate Predictor — Theme Button</title>
<style>
/* --- Base CSS variables (will be overwritten by JS themes) --- */
:root{
  --bg: #f4f6fb;
  --card: #fff;
  --accent-h: 210;
  --accent-s: 65%;
  --accent-l: 50%;
  --accent: hsl(var(--accent-h) var(--accent-s) var(--accent-l));
  --accent-2: hsl(var(--accent-h) calc(var(--accent-s) - 8%) calc(var(--accent-l) + 6%));
  --text: #111827;
  --border: #e5e7eb;
  --shadow: 0 6px 22px rgba(0,0,0,0.06);
  --danger: #ef4444;
  --muted: #9ca3af;
  --card-shadow: rgba(15,23,42,0.06);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg);
  color:var(--text); display:flex; justify-content:center; padding:18px; min-height:100vh;
  transition: background 320ms ease, color 320ms ease;
}
.container{
  width:100%; max-width:980px; background:var(--card); border-radius:14px;
  box-shadow:0 10px 30px var(--card-shadow); padding:18px; overflow:hidden;
  transition: background 320ms ease, box-shadow 320ms ease;
}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
.title{ font-size:1.4rem; color:var(--accent); font-weight:700; margin:0; transition: color 320ms ease; }
.tabbar{ display:flex; gap:8px; align-items:center; overflow:auto; padding:6px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02); }
.tab{display:flex;gap:8px;align-items:center;padding:8px 10px;border-radius:8px;cursor:pointer;background:transparent;color:var(--text);border:1px solid transparent;white-space:nowrap;transition:background 220ms, border-color 220ms;}
.tab.active{ background: linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00)); border-color: color-mix(in srgb, var(--accent) 12%, transparent); box-shadow:0 1px 0 rgba(0,0,0,0.03); }
.tab .close{ background:transparent; border:none; color:var(--muted); cursor:pointer; font-weight:700; }
.addBtn{ padding:8px 10px; border-radius:8px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:700; transition: background 220ms; }
.controls{ display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
.leftCol{ flex:1 1 320px; min-width:260px; }
.rightCol{ flex:1 1 540px; min-width:300px; }
.field{ display:flex; flex-direction:column; gap:6px; margin-bottom:6px; }
textarea, input[type="text"], input[type="number"]{ width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:1rem; background:transparent; color:var(--text); transition: border-color 180ms; }
textarea:focus, input:focus{ border-color: var(--accent-2); outline:none; box-shadow:0 4px 12px rgba(0,0,0,0.04); }
.tx{ min-height:110px; resize:vertical; }
.btnRow{ display:flex; gap:8px; align-items:center; }
.btn{ padding:9px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:700; transition: background 220ms, transform 80ms; }
.btn.muted{ background:var(--muted); }
.btn.danger{ background:var(--danger); }
.results{ margin-top:14px; transition: opacity 160ms ease; }
.avg-box{ background:color-mix(in srgb, var(--accent) 8%, #fff); border:1px solid color-mix(in srgb, var(--accent) 12%, #eef2ff); padding:10px; border-radius:8px; font-weight:700; margin-top:8px; color:var(--text); }
.table{ width:100%; border-collapse:collapse; margin-top:12px; font-family:monospace; }
.table th, .table td{ border:1px solid color-mix(in srgb, var(--accent) 6%, #eef2f7); padding:6px 8px; text-align:right; }
.table th{ background: color-mix(in srgb, var(--accent) 4%, #fbfdff); text-align:left; }
canvas{ width:100%; aspect-ratio:16/9; margin-top:14px; border-radius:8px; background:var(--card); box-shadow:inset 0 0 0 1px color-mix(in srgb, var(--accent) 3%, #eef2f7); }

/* Floating theme button */
.theme-fab{
  position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%;
  border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.18); transition: transform 180ms, box-shadow 180ms;
  z-index:2000;
}
.theme-fab:active{ transform:scale(0.96); }

/* small color circle inside FAB */
.theme-dot{ width:34px; height:34px; border-radius:50%; border:2px solid rgba(255,255,255,0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.12); }

/* Help popup */
.popup-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; }
.popup{ background:var(--card); width:92%; max-width:640px; border-radius:12px; padding:18px; box-shadow:var(--shadow); position:relative; color:var(--text); }
.popup h2{ color:var(--accent); margin-top:0; }
.popup .close{ position:absolute; right:12px; top:12px; background:var(--danger); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer; font-weight:700; }

/* small helpers */
.small{ font-size:0.95rem; color:var(--muted); }
@media(max-width:720px){
  .controls{ flex-direction:column; }
  .leftCol,.rightCol{ min-width:100%; }
}
</style>
</head>
<body>
<div class="container" role="application" id="appContainer">
  <div class="header">
    <div style="display:flex;flex-direction:column;">
      <div style="display:flex;align-items:center;gap:12px;">
        <h1 class="title">Share Rate Predictor</h1>
        <div class="tabbar" id="tabbar" aria-label="Stock tabs"></div>
      </div>
      <div class="small" style="margin-top:8px">Click the floating theme button (bottom-right) to cycle app themes.</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn muted" id="helpBtnTop">Help</button>
      <button class="addBtn" id="addStockBtn">+ Add Stock</button>
    </div>
  </div>

  <div class="controls">
    <div class="leftCol">
      <div class="field">
        <label>Stock / Share (active tab name)</label>
        <input id="stockNameInput" type="text" placeholder="Enter or rename stock here" />
      </div>

      <div class="field">
        <label>Enter past share rates (space or newline separated):</label>
        <textarea id="dataInput" class="tx" placeholder="e.g. 100 102 105 107 ..."></textarea>
      </div>

      <div class="field">
        <label>Prediction windows (n, space separated):</label>
        <input id="nInput" type="text" placeholder="e.g. 3 5 10" />
      </div>

      <div style="display:flex;gap:12px;align-items:flex-end;">
        <div style="flex:1">
          <label>Decimal precision</label>
          <input id="decimalsInput" type="number" min="0" max="12" />
        </div>
        <div style="align-self:flex-end">
          <div class="btnRow">
            <button class="btn" id="toggleGraphBtn">Hide Graph</button>
            <button class="btn danger" id="clearBtn">Clear All</button>
          </div>
        </div>
      </div>
    </div>

    <div class="rightCol">
      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- Help popup -->
<div class="popup-overlay" id="helpOverlay" role="dialog" aria-modal="true">
  <div class="popup">
    <button class="close" id="closeHelp">&times;</button>
    <h2>How to use — Share Rate Predictor</h2>
    <p><strong>Tabs:</strong> Each tab is a saved stock. Use <strong>+ Add Stock</strong> to add one. Click a tab to load it.</p>
    <p><strong>Rename:</strong> Edit the stock name box (above data) to rename the current tab and save automatically.</p>
    <p><strong>Share rates:</strong> Enter daily rates separated by spaces or new lines. The app calculates moving averages live.</p>
    <p><strong>Prediction windows:</strong> Enter integers (e.g. <code>3 5 10</code>) to compute multiple MAs.</p>
    <p><strong>Theme button:</strong> Tap the floating circular button bottom-right to cycle through 50 themes; the theme is saved globally.</p>
    <p class="small">All data is stored locally in your browser. This is a learning/visual tool — not financial advice.</p>
  </div>
</div>

<!-- Floating theme FAB -->
<button id="themeFab" class="theme-fab" aria-label="Change theme" title="Change theme">
  <div id="themeDot" class="theme-dot" style="background:var(--accent)"></div>
</button>

<script>
/* ===========================
   Stocks / Tabs & persistence
   =========================== */
const STOCK_LIST_KEY = 'ma_stocks_list_v1';
const STOCK_PREFIX = 'ma_stock_';
let stocks = [];
let currentId = null;

function makeId(){ return 's_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7); }
function k(id, field){ return `${STOCK_PREFIX}${id}::${field}`; }
function saveStocksList(){ localStorage.setItem(STOCK_LIST_KEY, JSON.stringify(stocks)); }
function loadStocksList(){ const raw = localStorage.getItem(STOCK_LIST_KEY); try{ stocks = raw ? JSON.parse(raw) : []; }catch(e){ stocks = []; } if(!Array.isArray(stocks)) stocks = []; }

/* ensure default */
function ensureDefaultStock(){
  if(stocks.length===0){
    const id = makeId();
    stocks.push({id, name:'Default'});
    saveStocksList();
    localStorage.setItem(k(id,'data'),'100 102 101 105 110 108 107 111 115 117');
    localStorage.setItem(k(id,'n'),'3 5');
    localStorage.setItem(k(id,'decimals'),'2');
    localStorage.setItem(k(id,'graph'),'true');
  }
}

/* Tabs UI */
const tabbar = document.getElementById('tabbar');
const addStockBtn = document.getElementById('addStockBtn');
const stockNameInput = document.getElementById('stockNameInput');

function renderTabs(){
  tabbar.innerHTML = '';
  stocks.forEach(s=>{
    const t = document.createElement('div');
    t.className = 'tab' + (s.id===currentId ? ' active' : '');
    t.dataset.id = s.id;

    const nameSpan = document.createElement('span');
    nameSpan.textContent = s.name;
    nameSpan.style.fontWeight = '600';
    nameSpan.title = 'Click to select. Double-click to rename.';
    nameSpan.addEventListener('click', ()=> selectStock(s.id));
    nameSpan.addEventListener('dblclick', ()=>{
      const input = document.createElement('input');
      input.className = 'rename-input';
      input.value = s.name;
      input.addEventListener('blur', ()=> finishRename(s.id, input.value));
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') input.blur(); });
      t.replaceChild(input, nameSpan);
      input.focus();
    });
    t.appendChild(nameSpan);

    const closeBtn = document.createElement('button');
    closeBtn.className = 'close';
    closeBtn.title = 'Delete stock';
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      deleteStockPrompt(s.id);
    });
    t.appendChild(closeBtn);
    tabbar.appendChild(t);
  });
}

addStockBtn.addEventListener('click', ()=>{
  const name = prompt('Enter new stock name (e.g. AAPL):') || '';
  const trimmed = name.trim() || ('Stock '+(stocks.length+1));
  const id = makeId();
  stocks.push({id, name: trimmed});
  localStorage.setItem(k(id,'data'),'');
  localStorage.setItem(k(id,'n'),'');
  localStorage.setItem(k(id,'decimals'),'');
  localStorage.setItem(k(id,'graph'),'true');
  saveStocksList();
  currentId = id;
  renderTabs();
  loadCurrentStock();
});

function deleteStockPrompt(id){
  const st = stocks.find(s=>s.id===id);
  if(!st) return;
  if(!confirm(`Delete "${st.name}" and its saved data? This cannot be undone.`)) return;
  ['data','n','decimals','graph'].forEach(f=> localStorage.removeItem(k(id,f)));
  stocks = stocks.filter(s=>s.id!==id);
  saveStocksList();
  if(stocks.length>0) currentId = stocks[0].id;
  else { ensureDefaultStock(); loadStocksList(); currentId = stocks[0].id; }
  renderTabs();
  loadCurrentStock();
}
function finishRename(id, newName){
  const s = stocks.find(x=>x.id===id);
  if(!s) return;
  s.name = newName.trim() || s.name;
  saveStocksList();
  renderTabs();
  if(id===currentId) stockNameInput.value = s.name;
}
function selectStock(id){
  if(!stocks.find(s=>s.id===id)) return;
  currentId = id;
  renderTabs();
  loadCurrentStock();
}

/* Load / Save per-stock */
function loadCurrentStock(){
  if(!currentId) currentId = stocks[0] && stocks[0].id;
  const id = currentId;
  document.getElementById('dataInput').value = localStorage.getItem(k(id,'data')) || '';
  document.getElementById('nInput').value = localStorage.getItem(k(id,'n')) || '';
  document.getElementById('decimalsInput').value = localStorage.getItem(k(id,'decimals')) || '';
  const graph = localStorage.getItem(k(id,'graph'));
  graphVisible = (graph === null) ? true : (graph !== 'false');
  updateGraphButton();
  const st = stocks.find(s=>s.id===id);
  stockNameInput.value = st ? st.name : '';
  computeAndRender();
}
function saveCurrentStock(){
  if(!currentId) return;
  const id = currentId;
  localStorage.setItem(k(id,'data'), document.getElementById('dataInput').value);
  localStorage.setItem(k(id,'n'), document.getElementById('nInput').value);
  localStorage.setItem(k(id,'decimals'), document.getElementById('decimalsInput').value);
  localStorage.setItem(k(id,'graph'), graphVisible ? 'true' : 'false');
  const name = (stockNameInput.value || '').trim();
  const s = stocks.find(x=>x.id===id);
  if(s && name && s.name !== name){ s.name = name; saveStocksList(); renderTabs(); }
}

/* Clear All for current stock */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!currentId) return;
  if(!confirm('Clear all data for this stock? This empties inputs and removes saved values.')) return;
  ['data','n','decimals','graph'].forEach(f => localStorage.removeItem(k(currentId,f)));
  document.getElementById('dataInput').value = '';
  document.getElementById('nInput').value = '';
  document.getElementById('decimalsInput').value = '';
  graphVisible = false;
  updateGraphButton();
  document.getElementById('results').innerHTML = '';
});

/* ===========================
   Calculation & chart rendering
   =========================== */
let graphVisible = true;
const resultsEl = document.getElementById('results');

function parseNumbers(text){
  const parts = (text||'').trim().split(/[\s,]+/).filter(Boolean);
  const nums = [], bad = [];
  for(const p of parts){
    const v = Number(p);
    if(Number.isFinite(v)) nums.push(v);
    else bad.push(p);
  }
  return {nums,bad};
}
function movingAverage(values,n){ const out = Array(values.length).fill(null); let sum=0; for(let i=0;i<values.length;i++){ sum+=values[i]; if(i>=n) sum-=values[i-n]; if(i>=n-1) out[i]=sum/n; } return out; }
function average(arr){ const valid=arr.filter(v=>v!=null && Number.isFinite(v)); return valid.length ? valid.reduce((a,b)=>a+b,0)/valid.length : null; }
function round(num,d){ const f=Math.pow(10,d||0); return Math.round((num+Number.EPSILON)*f)/f; }

/* theme system: 50 themes defined by hue and bg lightness variant */
const THEMES = (()=>{
  const arr=[];
  for(let i=0;i<50;i++){
    const hue = Math.round(i * 360 / 50);
    // alternate background lightness for variety
    const bgL = (i % 3 === 0) ? 97 : ((i % 3 === 1) ? 95 : 92);
    // accent saturation and lightness
    const s = (i % 7 === 0) ? 72 : 65;
    const l = (i % 5 === 0) ? 45 : 52;
    arr.push({h: hue, s, l, bgL});
  }
  return arr;
})();

/* apply theme by index (global) */
const THEME_KEY = 'ma_theme_index_v1';
function applyTheme(index){
  const idx = Math.max(0, Math.min(THEMES.length-1, index|0));
  const t = THEMES[idx];
  // compute CSS vars
  const accentVal = `hsl(${t.h} ${t.s}% ${t.l}%)`;
  const accent2Val = `hsl(${t.h} ${Math.max(20,t.s-10)}% ${Math.min(88,t.l+10)}%)`;
  const bgVal = `hsl(${t.h} ${Math.max(7, t.s/6)}% ${t.bgL}%)`;
  // card color slightly lighter/darker than bg
  const cardL = Math.max(100 - (100 - t.bgL) - 2, t.bgL - 3);
  const cardVal = `hsl(${t.h} ${Math.max(6, t.s/7)}% ${Math.min(99, Math.max(98, cardL - 2))}%)`;
  // text color: choose dark or light depending on bgL
  const textVal = (t.bgL > 88) ? '#0b1220' : '#0b1220';
  // border subtle
  const borderVal = `hsl(${t.h} ${Math.max(6, t.s/8)}% ${Math.max(88, t.bgL - 6)}%)`;
  // box-shadow color from accent with low alpha
  const cardShadow = `0 10px 30px color-mix(in srgb, ${accentVal} 12%, transparent)`;

  const root = document.documentElement;
  root.style.setProperty('--accent-h', String(t.h));
  root.style.setProperty('--accent-s', `${t.s}%`);
  root.style.setProperty('--accent-l', `${t.l}%`);
  root.style.setProperty('--accent', accentVal);
  root.style.setProperty('--accent-2', accent2Val);
  root.style.setProperty('--bg', bgVal);
  root.style.setProperty('--card', cardVal);
  root.style.setProperty('--text', textVal);
  root.style.setProperty('--border', borderVal);
  root.style.setProperty('--card-shadow', 'rgba(15,23,42,0.06)');
  // update floating dot
  document.getElementById('themeDot').style.background = accentVal;
  // save selection
  localStorage.setItem(THEME_KEY, String(idx));
  // re-render (chart colors depend on accent)
  computeAndRender();
}

/* draw chart — derive MA colors from accent hue */
function r(){ return window.devicePixelRatio || 1; }
function drawChart(canvas, values, maSets, nValues){
  const ctx = canvas.getContext('2d');
  const DPR = r();
  const w = Math.max(400, Math.floor(canvas.clientWidth * DPR));
  const h = Math.floor(canvas.clientHeight * DPR);
  canvas.width = w; canvas.height = h;
  ctx.clearRect(0,0,w,h);
  if(values.length===0) return;

  const all = [...values, ...maSets.flat().filter(x=>x!=null)];
  const min = Math.min(...all), max = Math.max(...all);
  const pad = (max - min) * 0.1 || 1;
  const ymin = min - pad, ymax = max + pad;
  const margin = {l:50*r(), r:20*r(), t:30*r(), b:40*r()};
  const pw = w - margin.l - margin.r, ph = h - margin.t - margin.b;
  const x = i => margin.l + (i/(values.length-1 || 1)) * pw;
  const y = v => margin.t + (1 - (v - ymin)/(ymax - ymin)) * ph;

  // grid + labels
  ctx.strokeStyle = "#e9eef6"; ctx.lineWidth = 1*r();
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#111827';
  ctx.font = `${12*r()}px sans-serif`;
  for(let i=0;i<=5;i++){
    const gy = margin.t + (i/5)*ph;
    ctx.beginPath(); ctx.moveTo(margin.l,gy); ctx.lineTo(margin.l+pw,gy); ctx.stroke();
    const labelVal = round(ymax - (i/5)*(ymax-ymin), 2);
    ctx.fillText(labelVal.toString(), 6*r(), gy + 4*r());
  }

  // axes
  ctx.strokeStyle = "#cfd8e6"; ctx.lineWidth = 1.5*r();
  ctx.beginPath(); ctx.moveTo(margin.l,margin.t); ctx.lineTo(margin.l,margin.t+ph); ctx.lineTo(margin.l+pw,margin.t+ph); ctx.stroke();
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
  ctx.font = `${13*r()}px sans-serif`;
  ctx.fillText("Days", (w/2)-15*r(), h - 8*r());
  ctx.save(); ctx.translate(14*r(), h/2 + 28*r()); ctx.rotate(-Math.PI/2); ctx.fillText("Rate", 0, 0); ctx.restore();

  // raw color from CSS var --accent (will be hsl string)
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#2563eb';
  ctx.strokeStyle = accent; ctx.lineWidth = 2.6*r();
  ctx.beginPath();
  values.forEach((v,i)=>{ const xi=x(i), yi=y(v); if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); });
  ctx.stroke();

  // compute base hue from --accent-h and create MA colors by rotating hue
  const hue = Number(getComputedStyle(document.documentElement).getPropertyValue('--accent-h')) || 210;
  const s = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--accent-s')) || 65;
  const l = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--accent-l')) || 50;

  const maColors = maSets.map((_, idx) => {
    const h2 = (hue + (idx+1) * 28) % 360;
    return `hsl(${h2} ${Math.max(30, s-6)}% ${Math.min(64, l+6)}%)`;
  });

  maSets.forEach((set, idx)=>{
    const color = maColors[idx % maColors.length];
    ctx.strokeStyle = color; ctx.lineWidth = 2*r(); ctx.setLineDash([6*r(),4*r()]);
    ctx.beginPath();
    set.forEach((v,i)=>{ if(v==null) return; const xi=x(i), yi=y(v); if(!isFinite(yi)) return; if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); });
    ctx.stroke(); ctx.setLineDash([]);
  });

  // legend
  ctx.font = `${13*r()}px sans-serif`; ctx.textBaseline = "middle";
  ctx.fillStyle = accent; ctx.fillRect(margin.l, margin.t - 18*r(), 12*r(), 12*r());
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
  ctx.fillText(`raw`, margin.l + 18*r(), margin.t - 12*r());
  nValues.forEach((n,i)=>{
    ctx.fillStyle = maColors[i % maColors.length];
    ctx.fillRect(margin.l + (i+1)*92*r(), margin.t - 18*r(), 12*r(), 12*r());
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
    ctx.fillText(`n=${n}`, margin.l + (i+1)*92*r() + 18*r(), margin.t - 12*r());
  });
}

/* render tables and chart */
function render(values, maSets, nValues, decimals, bad){
  resultsEl.innerHTML = '';
  if(graphVisible && values.length){
    const canvas = document.createElement('canvas');
    canvas.style.width = '100%';
    canvas.style.height = 'auto';
    resultsEl.appendChild(canvas);
    drawChart(canvas, values, maSets, nValues);
  }
  nValues.forEach((n,i)=>{
    const ma = maSets[i];
    const avgMA = average(ma);
    const table = document.createElement('table');
    table.className = 'table';
    const head = `<thead><tr><th>Index</th><th>Rate</th><th>${n}-Day Avg</th></tr></thead>`;
    const rows = values.map((v,idx)=>{
      const val = (decimals>=0) ? round(v,decimals).toFixed(decimals) : v;
      const mv = ma[idx]==null ? '—' : (decimals>=0 ? round(ma[idx],decimals).toFixed(decimals) : ma[idx]);
      return `<tr><td style="text-align:left">${idx+1}</td><td>${val}</td><td>${mv}</td></tr>`;
    }).join('');
    table.innerHTML = head + `<tbody>${rows}</tbody>`;
    resultsEl.appendChild(table);
    const avgBox = document.createElement('div');
    avgBox.className = 'avg-box';
    avgBox.textContent = `Average of ${n}-day MA: ${avgMA==null ? '—' : (decimals>=0 ? round(avgMA,decimals).toFixed(decimals) : avgMA)}`;
    resultsEl.appendChild(avgBox);
  });
  if(bad.length){
    const warn = document.createElement('div');
    warn.className = 'avg-box';
    warn.style.background = '#fff7f7';
    warn.style.border = '1px solid #fde2e2';
    warn.style.color = 'var(--danger)';
    warn.textContent = 'Ignored invalid entries: ' + bad.join(' ');
    resultsEl.appendChild(warn);
  }
}

/* compute & render and autosave */
function computeAndRender(){
  saveCurrentStock();
  const txt = document.getElementById('dataInput').value || '';
  const {nums, bad} = parseNumbers(txt);
  const nText = document.getElementById('nInput').value || '';
  const decimalsRaw = document.getElementById('decimalsInput').value;
  const decimals = decimalsRaw === '' ? 2 : Math.min(12, Math.max(0, Number(decimalsRaw)));
  if(nums.length===0) { resultsEl.innerHTML = ''; return; }
  const nValues = nText.split(/[\s,]+/).map(s=>Number(s.trim())).filter(n=>Number.isInteger(n) && n>0);
  if(nValues.length===0){ resultsEl.innerHTML = ''; return; }
  const maSets = nValues.map(n => movingAverage(nums, n));
  render(nums, maSets, nValues, decimals, bad);
}

/* events */
['input','change'].forEach(ev=>{
  ['dataInput','nInput','decimalsInput','stockNameInput'].forEach(id=>{
    document.getElementById(id).addEventListener(ev, ()=>{
      if(id==='stockNameInput' && currentId){
        const newName = document.getElementById('stockNameInput').value.trim();
        const s = stocks.find(x=>x.id===currentId);
        if(s && newName && s.name !== newName){ s.name = newName; saveStocksList(); renderTabs(); }
      }
      computeAndRender();
    });
  });
});

/* graph toggle */
const toggleGraphBtn = document.getElementById('toggleGraphBtn');
function updateGraphButton(){ toggleGraphBtn.textContent = graphVisible ? 'Hide Graph' : 'Show Graph'; toggleGraphBtn.classList.toggle('muted', !graphVisible); }
toggleGraphBtn.addEventListener('click', ()=>{ graphVisible = !graphVisible; updateGraphButton(); computeAndRender(); });

/* help popup */
document.getElementById('helpBtnTop').addEventListener('click', ()=> document.getElementById('helpOverlay').style.display = 'flex');
document.getElementById('closeHelp').addEventListener('click', ()=> document.getElementById('helpOverlay').style.display = 'none');
document.getElementById('helpOverlay').addEventListener('click', (e)=> { if(e.target === document.getElementById('helpOverlay')) document.getElementById('helpOverlay').style.display = 'none'; });

/* keyboard shortcut */
document.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); addStockBtn.click(); } });

/* Initialize stocks & UI */
function init(){
  loadStocksList();
  ensureDefaultStock();
  loadStocksList();
  currentId = stocks[0] && stocks[0].id;
  renderTabs();
  loadCurrentStock();
  updateGraphButton();
  // apply saved theme or default 0
  const savedTheme = Number(localStorage.getItem(THEME_KEY) || 0);
  applyTheme(savedTheme);
}
init();

/* --------------------------
   Floating Theme FAB logic
   -------------------------- */
const themeFab = document.getElementById('themeFab');
const themeDot = document.getElementById('themeDot');
let themeIndex = Number(localStorage.getItem(THEME_KEY) || 0);

themeFab.addEventListener('click', ()=>{
  themeIndex = (themeIndex + 1) % THEMES.length;
  applyTheme(themeIndex);
});

/* allow long-press (or shift+click) to go backwards */
themeFab.addEventListener('contextmenu', (e)=>{ e.preventDefault(); themeIndex = (themeIndex - 1 + THEMES.length) % THEMES.length; applyTheme(themeIndex); });

/* helper parseNumbers used earlier */
function parseNumbers(text){ const parts=(text||'').trim().split(/[\s,]+/).filter(Boolean); const nums=[], bad=[]; for(const p of parts){ const v=Number(p); if(Number.isFinite(v)) nums.push(v); else bad.push(p); } return {nums,bad}; }

</script>
</body>
</html>
