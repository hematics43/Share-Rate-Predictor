<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Share Rate Predictor — Tabs</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --accent:#2563eb; --accent-2:#3b82f6; --text:#111827;
  --border:#e5e7eb; --shadow: 0 6px 22px rgba(0,0,0,0.06); --danger:#ef4444; --muted:#9ca3af;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg);
  color:var(--text); display:flex; justify-content:center; padding:18px; min-height:100vh;
}
.container{
  width:100%; max-width:980px; background:var(--card); border-radius:14px; box-shadow:var(--shadow);
  padding:18px; overflow:hidden;
}
.header{
  display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px;
}
.title { font-size:1.4rem; color:var(--accent); font-weight:700; margin:0; }
.tabbar {
  display:flex; gap:8px; align-items:center; overflow:auto; padding:6px; border-radius:10px;
  background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02);
}
.tab {
  display:flex; gap:8px; align-items:center; padding:8px 10px; border-radius:8px; cursor:pointer;
  background:transparent; color:var(--text); border:1px solid transparent; white-space:nowrap;
}
.tab.active { background:linear-gradient(90deg,#eef6ff,#f5fbff); border-color:#dbeafe; box-shadow:0 1px 0 rgba(0,0,0,0.03); }
.tab .close { background:transparent; border:none; color:var(--muted); cursor:pointer; font-weight:700; }
.addBtn { padding:8px 10px; border-radius:8px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:700; }
.controls { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
.leftCol { flex:1 1 320px; min-width:260px; }
.rightCol { flex:1 1 540px; min-width:300px; }
.field { display:flex; flex-direction:column; gap:6px; margin-bottom:6px;}
textarea, input[type="text"], input[type="number"]{
  width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:1rem;
}
.tx { min-height:110px; resize:vertical; }
.btnRow { display:flex; gap:8px; align-items:center; }
.btn { padding:9px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:700; }
.btn.muted { background:var(--muted); color:white; }
.btn.danger { background:var(--danger); color:white; }
.results { margin-top:14px; }
.avg-box { background:#f8fafc; border:1px solid #eef2ff; padding:10px; border-radius:8px; font-weight:700; margin-top:8px; }
.table { width:100%; border-collapse:collapse; margin-top:12px; font-family:monospace; }
.table th, .table td { border:1px solid #eef2f7; padding:6px 8px; text-align:right; }
.table th { background:#fbfdff; text-align:left; }
canvas { width:100%; aspect-ratio:16/9; margin-top:14px; border-radius:8px; background:white; box-shadow:inset 0 0 0 1px #eef2f7; }
.helpBtn{ background:var(--accent-2); border:none; color:white; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700;}
.popup-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999;}
.popup{ background:white; width:92%; max-width:640px; border-radius:12px; padding:18px; box-shadow:var(--shadow); position:relative;}
.popup h2{ color:var(--accent); margin-top:0; }
.popup .close{ position:absolute; right:12px; top:12px; background:var(--danger); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer; font-weight:700;}
.small{ font-size:0.95rem; color:var(--muted); }
.tabs-wrap{ display:flex; align-items:center; gap:12px; width:100%; }
.tab-input { min-width:160px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); }
.rename-input { padding:4px 6px; border-radius:6px; border:1px solid var(--border); }
@media(max-width:720px){
  .controls{ flex-direction:column; }
  .leftCol, .rightCol{ min-width:100%; }
}
</style>
</head>
<body>
<div class="container" role="application">
  <div class="header">
    <div style="display:flex;flex-direction:column;">
      <div class="tabs-wrap">
        <div style="margin-right:12px"><h1 class="title">Share Rate Predictor</h1></div>
        <div class="tabbar" id="tabbar" aria-label="Stock tabs"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button class="helpBtn" id="helpBtnTop">Help</button>
      <button class="addBtn" id="addStockBtn">+ Add Stock</button>
    </div>
  </div>

  <div class="controls">
    <div class="leftCol">
      <div class="field">
        <label>Stock / Share (active tab name)</label>
        <input id="stockNameInput" type="text" class="tab-input" placeholder="Enter or rename stock here" />
      </div>
      <div class="field">
        <label>Enter past share rates (space or newline separated):</label>
        <textarea id="dataInput" class="tx" placeholder="e.g. 100 102 105 107 ..."></textarea>
      </div>

      <div class="field">
        <label>Prediction windows (n, space separated):</label>
        <input id="nInput" type="text" placeholder="e.g. 3 5 10" />
      </div>

      <div style="display:flex;gap:12px;">
        <div style="flex:1">
          <label>Decimal precision</label>
          <input id="decimalsInput" type="number" min="0" max="12" />
        </div>
        <div style="align-self:flex-end">
          <div class="btnRow">
            <button class="btn" id="toggleGraphBtn">Hide Graph</button>
            <button class="btn danger" id="clearBtn">Clear All</button>
          </div>
        </div>
      </div>

    </div>

    <div class="rightCol">
      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- Help popup -->
<div class="popup-overlay" id="helpOverlay" role="dialog" aria-modal="true">
  <div class="popup">
    <button class="close" id="closeHelp">&times;</button>
    <h2>How to use — Share Rate Predictor</h2>
    <p><strong>Tabs:</strong> Each tab is a stock. Use <strong>+ Add Stock</strong> to add one. Click a tab to load it.</p>
    <p><strong>Rename:</strong> Edit the stock name box (above data) to rename the current tab and save automatically.</p>
    <p><strong>Share rates:</strong> Enter daily rates separated by spaces or new lines. The app calculates moving averages live.</p>
    <p><strong>Prediction windows:</strong> Enter one or more integers (e.g. <code>3 5 10</code>) to compute multiple MAs.</p>
    <p><strong>Clear All:</strong> Clears the current tab’s saved values (localStorage) and empties inputs.</p>
    <p><strong>Delete tab:</strong> Use the small × on a tab to delete that stock and its saved data (confirmation required).</p>
    <p class="small">All data is stored locally in your browser. This is a learning/visual tool — not financial advice.</p>
  </div>
</div>

<script>
/* ---------------------------
   Storage keys & helpers
   --------------------------- */
const STOCK_LIST_KEY = 'ma_stocks_list_v1'; // stores array of {id,name}
const STOCK_PREFIX = 'ma_stock_';            // then id suffix keys: data, n, decimals, graphVisible
let stocks = []; // array of {id,name}
let currentId = null;

/* generate unique id */
function makeId(){ return 's_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7); }

/* key builder */
function k(id, field){ return `${STOCK_PREFIX}${id}::${field}`; }

/* save stocks list */
function saveStocksList(){ localStorage.setItem(STOCK_LIST_KEY, JSON.stringify(stocks)); }

/* load stocks list */
function loadStocksList(){
  const raw = localStorage.getItem(STOCK_LIST_KEY);
  try {
    stocks = raw ? JSON.parse(raw) : [];
  } catch(e){ stocks = []; }
  if(!Array.isArray(stocks)) stocks = [];
}

/* create default if none */
function ensureDefaultStock(){
  if(stocks.length===0){
    const id = makeId();
    stocks.push({id, name:'Default'});
    saveStocksList();
    // populate default sample values
    localStorage.setItem(k(id,'data'), '100 102 101 105 110 108 107 111 115 117');
    localStorage.setItem(k(id,'n'), '3 5');
    localStorage.setItem(k(id,'decimals'), '2');
    localStorage.setItem(k(id,'graph'), 'true');
  }
}

/* ---------------------------
   UI: tabs rendering & actions
   --------------------------- */
const tabbar = document.getElementById('tabbar');
const addStockBtn = document.getElementById('addStockBtn');
const stockNameInput = document.getElementById('stockNameInput');

function renderTabs(){
  tabbar.innerHTML = '';
  stocks.forEach(s => {
    const t = document.createElement('div');
    t.className = 'tab' + (s.id===currentId ? ' active' : '');
    t.dataset.id = s.id;

    const nameSpan = document.createElement('span');
    nameSpan.textContent = s.name;
    nameSpan.style.fontWeight = '600';
    nameSpan.style.marginRight = '6px';
    nameSpan.title = 'Click to select. Double-click to rename.';
    // select
    nameSpan.addEventListener('click', ()=> selectStock(s.id));
    // double-click rename: turn into input
    nameSpan.addEventListener('dblclick', ()=>{
      const input = document.createElement('input');
      input.className = 'rename-input';
      input.value = s.name;
      input.addEventListener('blur', ()=> finishRename(s.id, input.value));
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') input.blur(); });
      t.replaceChild(input, nameSpan);
      input.focus();
    });

    t.appendChild(nameSpan);

    const closeBtn = document.createElement('button');
    closeBtn.className = 'close';
    closeBtn.title = 'Delete stock';
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      deleteStockPrompt(s.id);
    });
    t.appendChild(closeBtn);

    tabbar.appendChild(t);
  });

  // Add small spacer (keeps add button aligned)
}

/* add new stock */
addStockBtn.addEventListener('click', ()=>{
  const name = prompt('Enter new stock name (e.g. AAPL):') || '';
  const trimmed = name.trim() || ('Stock '+(stocks.length+1));
  const id = makeId();
  stocks.push({id, name: trimmed});
  // set defaults empty so user starts fresh
  localStorage.setItem(k(id,'data'), '');
  localStorage.setItem(k(id,'n'), '');
  localStorage.setItem(k(id,'decimals'), '');
  localStorage.setItem(k(id,'graph'), 'true');
  saveStocksList();
  currentId = id;
  renderTabs();
  loadCurrentStock(); // loads values into UI and auto-saves
});

/* delete stock after confirm */
function deleteStockPrompt(id){
  const st = stocks.find(s=>s.id===id);
  if(!st) return;
  if(!confirm(`Delete "${st.name}" and its saved data? This cannot be undone.`)) return;
  // remove storage keys for that id
  ['data','n','decimals','graph'].forEach(f=> localStorage.removeItem(k(id,f)));
  // remove from stocks array
  stocks = stocks.filter(s=>s.id!==id);
  saveStocksList();
  // pick a new current
  if(stocks.length>0) currentId = stocks[0].id;
  else { currentId = null; ensureDefaultStock(); loadStocksList(); currentId = stocks[0].id; }
  renderTabs();
  loadCurrentStock();
}

/* rename finishing */
function finishRename(id, newName){
  const s = stocks.find(x=>x.id===id);
  if(!s) return;
  s.name = newName.trim() || s.name;
  saveStocksList();
  renderTabs();
  // if renaming current, update input box
  if(id===currentId) stockNameInput.value = s.name;
}

/* select stock */
function selectStock(id){
  if(!stocks.find(s=>s.id===id)) return;
  currentId = id;
  renderTabs();
  loadCurrentStock();
}

/* ---------------------------
   Load / Save per-stock data
   --------------------------- */
function loadCurrentStock(){
  if(!currentId){
    const def = stocks[0];
    currentId = def && def.id;
  }
  const id = currentId;
  const data = localStorage.getItem(k(id,'data')) || '';
  const n = localStorage.getItem(k(id,'n')) || '';
  const decimals = localStorage.getItem(k(id,'decimals'));
  const graph = localStorage.getItem(k(id,'graph'));

  document.getElementById('dataInput').value = data;
  document.getElementById('nInput').value = n;
  document.getElementById('decimalsInput').value = (decimals===null ? '' : decimals);
  const st = stocks.find(s=>s.id===id);
  stockNameInput.value = st ? st.name : '';
  graphVisible = (graph === null) ? true : (graph !== 'false');
  updateGraphButton();
  computeAndRender();
}

function saveCurrentStock(){
  if(!currentId) return;
  const id = currentId;
  localStorage.setItem(k(id,'data'), document.getElementById('dataInput').value);
  localStorage.setItem(k(id,'n'), document.getElementById('nInput').value);
  localStorage.setItem(k(id,'decimals'), document.getElementById('decimalsInput').value);
  localStorage.setItem(k(id,'graph'), graphVisible ? 'true' : 'false');
  // Also update tab name from input if changed
  const name = (stockNameInput.value || '').trim();
  const s = stocks.find(x=>x.id===id);
  if(s && name && s.name !== name){ s.name = name; saveStocksList(); renderTabs(); }
}

/* Clear All for current stock (empties fields and storage) */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!currentId) return;
  if(!confirm('Clear all data for this stock? This empties inputs and removes saved values.')) return;
  ['data','n','decimals','graph'].forEach(f => localStorage.removeItem(k(currentId,f)));
  document.getElementById('dataInput').value = '';
  document.getElementById('nInput').value = '';
  document.getElementById('decimalsInput').value = '';
  graphVisible = false;
  updateGraphButton();
  document.getElementById('results').innerHTML = '';
});

/* ---------------------------
   Calculation & rendering
   --------------------------- */
let graphVisible = true;
const resultsEl = document.getElementById('results');

function parseNumbers(text){
  const parts = (text||'').trim().split(/[\s,]+/).filter(Boolean);
  const nums = [], bad = [];
  for(const p of parts){
    const v = Number(p);
    if(Number.isFinite(v)) nums.push(v);
    else bad.push(p);
  }
  return {nums,bad};
}

function movingAverage(values, n){
  const out = Array(values.length).fill(null);
  let sum = 0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i>=n) sum -= values[i-n];
    if(i>=n-1) out[i] = sum / n;
  }
  return out;
}
function average(arr){ const valid = arr.filter(v=>v!=null && Number.isFinite(v)); return valid.length ? valid.reduce((a,b)=>a+b,0)/valid.length : null;}
function round(num,d){ const f = Math.pow(10,d||0); return Math.round((num+Number.EPSILON)*f)/f; }

function drawChart(canvas, values, maSets, nValues){
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const w = Math.max(400, Math.floor(canvas.clientWidth * DPR));
  const h = Math.floor(canvas.clientHeight * DPR);
  canvas.width = w; canvas.height = h;
  ctx.clearRect(0,0,w,h);

  if(values.length===0) return;

  const all = [...values, ...maSets.flat().filter(x=>x!=null)];
  const min = Math.min(...all), max = Math.max(...all);
  const pad = (max - min) * 0.1 || 1;
  const ymin = min - pad, ymax = max + pad;
  const margin = {l:50*r(), r:20*r(), t:30*r(), b:40*r()};
  const pw = w - margin.l - margin.r, ph = h - margin.t - margin.b;
  const x = i => margin.l + (i/(values.length-1 || 1))*pw;
  const y = v => margin.t + (1-(v-ymin)/(ymax-ymin))*ph;

  // grid + y labels
  ctx.strokeStyle = "#e9eef6"; ctx.lineWidth = 1*r();
  ctx.fillStyle = "#6b7280"; ctx.font = `${12*r()}px sans-serif`;
  for(let i=0;i<=5;i++){
    const gy = margin.t + (i/5)*ph;
    ctx.beginPath(); ctx.moveTo(margin.l,gy); ctx.lineTo(margin.l+pw,gy); ctx.stroke();
    const labelVal = round(ymax - (i/5)*(ymax-ymin), 2);
    ctx.fillText(labelVal.toString(), 6*r(), gy + 4*r());
  }

  // axes
  ctx.strokeStyle = "#cfd8e6"; ctx.lineWidth = 1.5*r();
  ctx.beginPath(); ctx.moveTo(margin.l,margin.t); ctx.lineTo(margin.l,margin.t+ph); ctx.lineTo(margin.l+pw,margin.t+ph); ctx.stroke();

  // axis labels
  ctx.fillStyle = "#6b7280"; ctx.font = `${13*r()}px sans-serif`;
  ctx.fillText("Days", (w/2)-15*r(), h - 8*r());
  ctx.save(); ctx.translate(14*r(), h/2 + 28*r()); ctx.rotate(-Math.PI/2); ctx.fillText("Rate", 0, 0); ctx.restore();

  // raw values (solid)
  ctx.strokeStyle = "#2563eb"; ctx.lineWidth = 2.2*r();
  ctx.beginPath();
  values.forEach((v,i)=>{ const xi=x(i), yi=y(v); if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); });
  ctx.stroke();

  // moving averages
  const colors = ["#ef4444","#10b981","#f59e0b","#8b5cf6","#14b8a6","#dc2626"];
  maSets.forEach((set, idx) => {
    ctx.strokeStyle = colors[idx % colors.length];
    ctx.lineWidth = 2*r(); ctx.setLineDash([6*r(),4*r()]);
    ctx.beginPath();
    set.forEach((v,i)=>{ if(v==null) return; const xi = x(i), yi = y(v); if(!isFinite(yi)) return; if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); });
    ctx.stroke();
    ctx.setLineDash([]);
  });

  // legend
  ctx.font = `${13*r()}px sans-serif`; ctx.textBaseline = "middle";
  nValues.forEach((n, i)=>{
    const sx = margin.l + i*100*r();
    const sy = margin.t - 10*r();
    ctx.fillStyle = colors[i % colors.length];
    ctx.fillRect(sx, sy, 12*r(), 12*r());
    ctx.fillStyle = "#111";
    ctx.fillText(`n=${n}`, sx + 18*r(), sy + 6*r());
  });
}

/* render tables and chart */
function render(values, maSets, nValues, decimals, bad){
  resultsEl.innerHTML = '';
  if(graphVisible && values.length){
    const canvas = document.createElement('canvas');
    canvas.style.width = '100%';
    canvas.style.height = 'auto';
    resultsEl.appendChild(canvas);
    drawChart(canvas, values, maSets, nValues);
  }
  nValues.forEach((n,i)=>{
    const ma = maSets[i];
    const avgMA = average(ma);
    const table = document.createElement('table');
    table.className = 'table';
    const head = `<thead><tr><th>Index</th><th>Rate</th><th>${n}-Day Avg</th></tr></thead>`;
    const rows = values.map((v,idx)=>{
      const val = (decimals>=0) ? round(v,decimals).toFixed(decimals) : v;
      const mv = ma[idx]==null ? '—' : (decimals>=0 ? round(ma[idx],decimals).toFixed(decimals) : ma[idx]);
      return `<tr><td style="text-align:left">${idx+1}</td><td>${val}</td><td>${mv}</td></tr>`;
    }).join('');
    table.innerHTML = head + `<tbody>${rows}</tbody>`;
    resultsEl.appendChild(table);
    const avgBox = document.createElement('div');
    avgBox.className = 'avg-box';
    avgBox.textContent = `Average of ${n}-day MA: ${avgMA==null ? '—' : (decimals>=0 ? round(avgMA,decimals).toFixed(decimals) : avgMA)}`;
    resultsEl.appendChild(avgBox);
  });
  if(bad.length){
    const warn = document.createElement('div');
    warn.className = 'avg-box';
    warn.style.background='#fff7f7';
    warn.style.border='1px solid #fde2e2';
    warn.style.color='var(--danger)';
    warn.textContent = 'Ignored invalid entries: ' + bad.join(' ');
    resultsEl.appendChild(warn);
  }
}

/* compute and render live */
function computeAndRender(){
  saveCurrentStock(); // autosave on each render
  const txt = document.getElementById('dataInput').value || '';
  const {nums, bad} = parseNumbers(txt);
  const nText = document.getElementById('nInput').value || '';
  const decimalsRaw = document.getElementById('decimalsInput').value;
  const decimals = decimalsRaw === '' ? 2 : Math.min(12, Math.max(0, Number(decimalsRaw)));
  if(nums.length===0) { resultsEl.innerHTML = ''; return; }
  const nValues = nText.split(/[\s,]+/).map(s=>Number(s.trim())).filter(n=>Number.isInteger(n) && n>0);
  if(nValues.length===0){ resultsEl.innerHTML = ''; return; }
  const maSets = nValues.map(n => movingAverage(nums, n));
  render(nums, maSets, nValues, decimals, bad);
}

/* wire up live events */
['input','change'].forEach(ev=>{
  ['dataInput','nInput','decimalsInput','stockNameInput'].forEach(id=>{
    document.getElementById(id).addEventListener(ev, ()=>{
      // special: if stock name changed, update stock object and save
      if(id==='stockNameInput' && currentId){
        const newName = document.getElementById('stockNameInput').value.trim();
        const s = stocks.find(x=>x.id===currentId);
        if(s && newName && s.name !== newName){ s.name = newName; saveStocksList(); renderTabs(); }
      }
      // live render
      computeAndRender();
    });
  });
});

/* graph toggle button */
const toggleGraphBtn = document.getElementById('toggleGraphBtn');
function updateGraphButton(){ toggleGraphBtn.textContent = graphVisible ? 'Hide Graph' : 'Show Graph'; toggleGraphBtn.classList.toggle('muted', !graphVisible); }
toggleGraphBtn.addEventListener('click', ()=>{ graphVisible = !graphVisible; updateGraphButton(); computeAndRender(); });

/* Add / Help events */
document.getElementById('helpBtnTop').addEventListener('click', ()=> document.getElementById('helpOverlay').style.display = 'flex');
document.getElementById('closeHelp').addEventListener('click', ()=> document.getElementById('helpOverlay').style.display = 'none');
document.getElementById('helpOverlay').addEventListener('click', (e)=> { if(e.target === document.getElementById('helpOverlay')) document.getElementById('helpOverlay').style.display = 'none'; });

/* utility for device pixel ratio scaling */
function r(){ return window.devicePixelRatio || 1; }

/* initialize on load */
function init(){
  loadStocksList();
  ensureDefaultStock();
  loadStocksList();
  // set first stock as current if none selected
  currentId = stocks[0] && stocks[0].id;
  renderTabs();
  loadCurrentStock();
  updateGraphButton();
}
/* keyboard: add new stock with ctrl+N */
document.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); addStockBtn.click(); } });

init();
</script>
</body>
</html>
